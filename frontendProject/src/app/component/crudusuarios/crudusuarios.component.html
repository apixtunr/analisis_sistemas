<div class="container my-5">
  <h2 class="mb-4 text-center">Gestión de Usuarios</h2>
  <button class="btn btn-secondary mb-3" routerLink="/menu">
    Volver al menú
  </button>

  <!-- Formulario para agregar/editar usuario -->
  <div class="card mb-5 shadow-sm">
    <div class="card-body">
      <form [formGroup]="usuarioForm"
        (ngSubmit)="isEditMode ? onUpdate() : onSubmit()">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">Usuario</label>
            <input
              type="text"
              formControlName="idUsuario"
              class="form-control"
              placeholder="Ingrese Usuario"
            />
          </div>
          <div class="col-md-3">
            <label class="form-label">Nombre</label>
            <input
              type="text"
              formControlName="nombre"
              class="form-control"
              placeholder="Ingrese nombre"
            />
          </div>
          <div class="col-md-3">
            <label class="form-label">Apellido</label>
            <input
              type="text"
              formControlName="apellido"
              class="form-control"
              placeholder="Ingrese apellido"
            />
          </div>
          <div class="col-md-3">
            <label class="form-label">Fecha Nacimiento</label>
            <input
              type="date"
              formControlName="fechaNacimiento"
              class="form-control"
            />
          </div>
        </div>

        <div class="row g-3 mt-3">
          <div class="col-md-3">
            <label class="form-label">Contraseña</label>
            <input
              type="password"
              formControlName="password"
              class="form-control"
              placeholder="Ingrese contraseña"
            />
          </div>
          <div class="col-md-3">
            <label class="form-label">Género</label>
            <select formControlName="idGenero" class="form-control">
              <option *ngFor="let genero of generos" [value]="genero.idgenero">
                {{ genero.nombre }}
              </option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Correo Electrónico</label>
            <input
              type="email"
              formControlName="correoElectronico"
              class="form-control"
              placeholder="Ingrese correo"
            />
          </div>
        </div>

        <div class="row g-3 mt-3">
          <div class="col-md-3">
            <label class="form-label">Fotografía</label>
            <input
              type="text"
              formControlName="fotografia"
              class="form-control"
              placeholder="URL o Base64"
            />
          </div>
          <div class="col-md-3 mt-2">
            <label class="form-label d-block">Vista previa</label>
            <img
              *ngIf="usuarioForm.get('fotografia')?.value"
              [src]="
                'data:image/png;base64,' + usuarioForm.get('fotografia')?.value
              "
              alt="Foto de perfil"
              class="img-thumbnail"
              style="width: 100px; height: 100px; object-fit: cover"
            />
          </div>

          <div class="col-md-3">
            <label class="form-label">Teléfono</label>
            <input
              type="text"
              formControlName="telefonoMovil"
              class="form-control"
              placeholder="Ingrese teléfono"
            />
          </div>
          <div class="col-md-3">
            <label class="form-label">Sucursal</label>
            <select formControlName="idSucursal" class="form-control">
              <option
                *ngFor="let sucursal of sucursales"
                [value]="sucursal.idSucursal"
              >
                {{ sucursal.nombre }}
              </option>
            </select>
          </div>
        </div>

        <div class="row g-3 mt-3">
          <div class="col-md-3">
            <label class="form-label">Pregunta</label>
            <input
              type="text"
              formControlName="pregunta"
              class="form-control"
              placeholder="Ingrese pregunta"
            />
          </div>
          <div class="col-md-3">
            <label class="form-label">Respuesta</label>
            <input
              type="text"
              formControlName="respuesta"
              class="form-control"
              placeholder="Ingrese respuesta"
            />
          </div>
        </div>

        <!-- Botones -->
        <div class="mt-4 d-flex gap-2">
          <button
              type="submit"
              class="btn btn-primary"
              [disabled]="usuarioForm.invalid"
            >
              {{ isEditMode ? "Actualizar Usuario" : "Agregar Usuario" }}
            </button>
          <button type="button" class="btn btn-secondary" (click)="onReset()">
            Limpiar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Tabla de usuarios -->
  <div class="table-responsive">
    <table class="table table-striped table-bordered align-middle">
      <thead class="table-dark">
        <tr>
          <th>Usuario</th>
          <th>Nombre</th>
          <th>Apellido</th>
          <th>Fecha Nacimiento</th>
          <th>Género</th>
          <th>Correo</th>
          <th>Fotografía</th>
          <th>Teléfono</th>
          <th>Sucursal</th>
          <th>Pregunta</th>
          <th>Respuesta</th>
          <th class="text-center">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let usr of usuarios">
          <td>{{ usr.idUsuario }}</td>
          <td>{{ usr.nombre }}</td>
          <td>{{ usr.apellido }}</td>
          <td>{{ usr.fechaNacimiento | date : "dd/MM/yyyy" }}</td>
          <td>{{ getGeneroNombre(usr.idGenero) }}</td>
          <td>{{ usr.correoElectronico }}</td>
          <td>
            <img
              *ngIf="usr.fotografia"
              [src]="'data:image/png;base64,' + usr.fotografia"
              alt="Foto de perfil"
              class="img-thumbnail"
              style="width: 50px; height: 50px; object-fit: cover"
            />
          </td>
          <td>{{ usr.telefonoMovil }}</td>
          <td>{{ getSucursalNombre(usr.idSucursal) }}</td>
          <td>{{ usr.pregunta }}</td>
          <td>{{ usr.respuesta }}</td>
          <td class="sticky-buttons">
            <div class="d-flex justify-content-center gap-2">
              <button class="btn btn-sm btn-info" (click)="onEdit(usr)">
                Editar
              </button>
              <button
                class="btn btn-sm btn-danger"
                (click)="onDelete(usr.idUsuario)"
              >
                Eliminar
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
